CC      = clang
CFLAGS  = -O0 -Wall
TARGET  = test.bin

# 필요 소스들 (상대경로도 가능: 예) ../utils.c 추가)
SRC_ALL = main.c victim.c attacker.c delay.c set_ghr.c branches.c
# SRC_ALL += ../utils.c

# branches.s가 있으면 그걸 쓰고, 없으면 branches.c를 쓴다
ifeq ($(wildcard branches.s),)
  BRANCHES_INPUT = branches.c
else
  BRANCHES_INPUT = branches.s
endif

# branches.c를 제외한 나머지 C들
SRC_C = $(filter-out branches.c,$(SRC_ALL))

.PHONY: all as bin clean

# all: as 후 bin (하지만 bin은 as에 의존하지 않음)
all: as bin

# 1) C → S (branches만)
as: branches.s

branches.s: branches.c
	$(CC) $(CFLAGS) -S -o $@ $<

# 2) C/S → 바이너리 (중간 .o 파일 생성 안 함)
bin:
	$(CC) $(CFLAGS) -o $(TARGET) $(SRC_C) $(BRANCHES_INPUT)

clean:
	rm -f $(TARGET) branches.s
